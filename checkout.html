<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Confirm Appointment | Dryer Dudes</title>
  <link rel="stylesheet" href="styles-v2.css" />
  <style>
    html, body { max-width: 100%; overflow-x: hidden; }
    .muted { opacity: 0.80; }
    .big { font-size: 1.2rem; font-weight: 800; }
    .pill { display:inline-block; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,0.14); background: rgba(255,255,255,0.04); }
    .danger { border-color: rgba(255,80,80,0.45); background: rgba(255,80,80,0.08); }
    .ok { border-color: rgba(0,200,255,0.45); background: rgba(0,200,255,0.10); }
    .hide { display:none; }
    .btn-row { display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .secondary-btn {
      display:inline-block;
      padding: 12px 14px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.06);
      color: #fff;
      font-weight: 700;
      cursor: pointer;
    }
    .secondary-btn:hover { opacity: .9; }
  </style>
</head>
<body>
  <div class="page">

    <section class="panel">
      <h2>Confirm your appointment</h2>
      <p class="subtext">This time slot is held temporarily. Payment is required to lock it in.</p>

      <div id="loadingCard" class="card">
        <div class="card-title">Loading your selected time…</div>
        <div class="card-text muted">Please wait.</div>
      </div>

      <div id="errorCard" class="card hide">
        <div class="card-title">This link is not valid</div>
        <div id="errorText" class="card-text muted"></div>

        <div class="btn-row">
          <button id="goHomeBtn" class="secondary-btn" type="button">Start over</button>
        </div>
      </div>

      <div id="slotTakenCard" class="card hide danger">
        <div class="card-title">That time is no longer available</div>
        <div id="slotTakenText" class="card-text muted">
          Please go back and choose a different time window.
        </div>

        <div class="btn-row">
          <button id="backBtn" class="secondary-btn" type="button">Go back</button>
          <button id="reloadBtn" class="secondary-btn" type="button">Reload</button>
          <button id="startOverBtn" class="secondary-btn" type="button">Start over</button>
        </div>
      </div>

      <div id="slotCard" class="card hide">
        <div class="card-title">Selected appointment</div>
        <div class="card-text">
          <div class="big" id="slotLine"></div>
          <div class="muted" style="margin-top:8px;">
            <span class="pill" id="typePill"></span>
            <span class="pill" id="zonePill" style="margin-left:6px;"></span>
          </div>
        </div>
      </div>

      <div id="payCard" class="card hide">
        <div class="card-title">Pay to confirm</div>
        <div class="card-text muted">
          Your appointment is <b>not confirmed</b> until payment is completed.
        </div>

        <button id="payBtn" class="submit-btn" type="button" style="margin-top:12px;">
          Pay $80 to confirm
        </button>

        <div id="payNote" class="help" style="margin-top:10px;"></div>
      </div>
    </section>

    <div class="footer">© 2026 Dryer Dudes</div>
  </div>

  <script>
    const $ = (s) => document.querySelector(s);

    function mmddyyyy(iso) {
      const m = String(iso || "").match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (!m) return String(iso || "");
      const [, y, mo, d] = m;
      return `${mo}/${d}/${y}`;
    }

    function fmtTime(t) {
      if (!t) return "";
      return String(t).slice(0, 5);
    }

    function slotDisplay(s) {
      const date = mmddyyyy(s.service_date);
      const start = fmtTime(s.start_time);
      const end = fmtTime(s.end_time);
      const time = (start && end) ? `${start}–${end}` : (s.slot_index != null ? `Slot ${s.slot_index}` : "Scheduled window");
      const label = s.window_label ? ` (${s.window_label})` : "";
      return `${date} • ${time}${label}`;
    }

    function show(el) { el?.classList.remove("hide"); }
    function hide(el) { el?.classList.add("hide"); }

    function showFatalError(msg) {
      hide($("#loadingCard"));
      hide($("#slotCard"));
      hide($("#payCard"));
      hide($("#slotTakenCard"));

      show($("#errorCard"));
      $("#errorText").textContent = msg || "Invalid or expired link.";
    }

    function showSlotTaken(msg) {
      hide($("#loadingCard"));
      hide($("#slotCard"));
      hide($("#payCard"));
      hide($("#errorCard"));

      show($("#slotTakenCard"));
      $("#slotTakenText").textContent = msg || "That appointment option is no longer available. Please pick another time.";
    }

    async function verifyOffer(token) {
      // cache-bust so we don’t accidentally use a cached response
      const url = `/api/verify-offer?token=${encodeURIComponent(token)}&_=${Date.now()}`;
      const resp = await fetch(url, { method: "GET" });
      const json = await resp.json().catch(() => ({}));
      return { resp, json };
    }

    async function main() {
      const token = new URLSearchParams(location.search).get("token");
      if (!token) {
        showFatalError("Missing token.");
        return;
      }

      // Buttons
      $("#goHomeBtn")?.addEventListener("click", () => location.href = "/");
      $("#startOverBtn")?.addEventListener("click", () => location.href = "/");
      $("#reloadBtn")?.addEventListener("click", () => location.reload());
      $("#backBtn")?.addEventListener("click", () => history.length > 1 ? history.back() : (location.href = "/"));

      // Initial verify + show details
      let offer = null;
      let apptType = "standard";
      let zone = "";

      try {
        const { resp, json } = await verifyOffer(token);

        hide($("#loadingCard"));

        if (!resp.ok || !json.ok) {
          const msg = json?.message || json?.error || "Invalid or expired link.";
          const code = String(json?.code || json?.error || "").toLowerCase();
          if (code.includes("inactive") || code.includes("taken") || resp.status === 409) {
            showSlotTaken(msg);
          } else {
            showFatalError(msg);
          }
          return;
        }

        offer = json.offer;
        apptType = json.appointment_type || "standard";
        zone = json.zone || offer.zone_code || "";

        show($("#slotCard"));
        show($("#payCard"));

        $("#slotLine").textContent = slotDisplay(offer);
        $("#typePill").textContent = apptType;
        $("#zonePill").textContent = zone ? `Zone ${zone}` : "Zone";
      } catch (e) {
        showFatalError("Could not load appointment details. Please try again.");
        return;
      }

      $("#payBtn").addEventListener("click", async () => {
        $("#payBtn").disabled = true;
        $("#payBtn").style.opacity = "0.8";
        $("#payNote").textContent = "Double-checking availability…";

        // ✅ Re-verify right before checkout (prevents “kept open page” issues)
        try {
          const { resp, json } = await verifyOffer(token);
          if (!resp.ok || !json.ok) {
            const msg = json?.message || json?.error || "That appointment option is no longer available.";
            const code = String(json?.code || json?.error || "").toLowerCase();
            if (code.includes("inactive") || code.includes("taken") || resp.status === 409) {
              showSlotTaken(msg);
            } else {
              showFatalError(msg);
            }
            return;
          }
        } catch (e) {
          $("#payBtn").disabled = false;
          $("#payBtn").style.opacity = "1";
          $("#payNote").textContent = "Network error. Please try again.";
          return;
        }

        $("#payNote").textContent = "Starting secure checkout…";

        let r2, j2;
        try {
          r2 = await fetch("/api/create-checkout-session", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ token })
          });
          j2 = await r2.json().catch(() => ({}));
        } catch (e) {
          $("#payBtn").disabled = false;
          $("#payBtn").style.opacity = "1";
          $("#payNote").textContent = "Network error. Please try again.";
          return;
        }

        // ✅ 409 = slot taken/unavailable (no charge / no redirect)
        if (r2.status === 409) {
          showSlotTaken(j2?.message || "That appointment option is no longer available. Please pick another time.");
          return;
        }

        // ✅ 410 = expired/invalid link
        if (r2.status === 410) {
          showFatalError(j2?.message || "This link has expired. Please request new appointment options.");
          return;
        }

        if (!r2.ok || !j2.ok) {
          $("#payBtn").disabled = false;
          $("#payBtn").style.opacity = "1";
          $("#payNote").textContent = j2?.message || j2?.error || `Could not start checkout (${r2.status}).`;
          return;
        }

        location.href = j2.url;
      });
    }

    main();
  </script>
</body>
</html>
