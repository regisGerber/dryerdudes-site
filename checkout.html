<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Confirm Appointment | Dryer Dudes</title>
  <link rel="stylesheet" href="styles-v2.css" />
  <style>
    html, body { max-width: 100%; overflow-x: hidden; }
    .muted { opacity: 0.80; }
    .big { font-size: 1.2rem; font-weight: 800; }
    .pill { display:inline-block; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,0.14); background: rgba(255,255,255,0.04); }
    .danger { border-color: rgba(255,80,80,0.45); background: rgba(255,80,80,0.08); }
    .ok { border-color: rgba(0,200,255,0.45); background: rgba(0,200,255,0.10); }
    .hide { display:none; }
  </style>
</head>
<body>
  <div class="page">

    <section class="panel">
      <h2>Confirm your appointment</h2>
      <p class="subtext">This time slot is held temporarily. Payment is required to lock it in.</p>

      <div id="loadingCard" class="card">
        <div class="card-title">Loading your selected time…</div>
        <div class="card-text muted">Please wait.</div>
      </div>

      <div id="errorCard" class="card hide">
        <div class="card-title">This link is not valid</div>
        <div id="errorText" class="card-text muted"></div>
      </div>

      <div id="slotCard" class="card hide">
        <div class="card-title">Selected appointment</div>
        <div class="card-text">
          <div class="big" id="slotLine"></div>
          <div class="muted" style="margin-top:8px;">
            <span class="pill" id="typePill"></span>
            <span class="pill" id="zonePill" style="margin-left:6px;"></span>
          </div>
        </div>
      </div>

      <div id="payCard" class="card hide">
        <div class="card-title">Pay to confirm</div>
        <div class="card-text muted">
          Your appointment is <b>not confirmed</b> until payment is completed.
        </div>

        <button id="payBtn" class="submit-btn" type="button" style="margin-top:12px;">
          Pay $80 to confirm
        </button>

        <div id="payNote" class="help" style="margin-top:10px;"></div>
      </div>
    </section>

    <div class="footer">© 2026 Dryer Dudes</div>
  </div>

  <script>
    const $ = (s) => document.querySelector(s);

    function mmddyyyy(iso) {
      // input: "YYYY-MM-DD"
      const m = String(iso || "").match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (!m) return String(iso || "");
      const [, y, mo, d] = m;
      return `${mo}/${d}/${y}`;
    }

    function fmtTime(t) {
      if (!t) return "";
      const s = String(t).slice(0, 5);
      return s;
    }

    function slotDisplay(s) {
      const date = mmddyyyy(s.service_date);
      const start = fmtTime(s.start_time);
      const end = fmtTime(s.end_time);
      const time = (start && end) ? `${start}–${end}` : (s.slot_index != null ? `Slot ${s.slot_index}` : "Scheduled window");
      const label = s.window_label ? ` (${s.window_label})` : "";
      return `${date} • ${time}${label}`;
    }

    async function main() {
      const token = new URLSearchParams(location.search).get("token");
      if (!token) {
        $("#loadingCard").classList.add("hide");
        $("#errorCard").classList.remove("hide");
        $("#errorText").textContent = "Missing token.";
        return;
      }

      // Verify token + fetch slot details
      const resp = await fetch(`/api/verify-offer?token=${encodeURIComponent(token)}`);
      const json = await resp.json().catch(() => ({}));

      $("#loadingCard").classList.add("hide");

      if (!resp.ok || !json.ok) {
        $("#errorCard").classList.remove("hide");
        $("#errorText").textContent = json?.message || json?.error || "Invalid or expired link.";
        return;
      }

      const offer = json.offer;

      $("#slotCard").classList.remove("hide");
      $("#payCard").classList.remove("hide");

      $("#slotLine").textContent = slotDisplay(offer);
      $("#typePill").textContent = json.appointment_type || "standard";
      $("#zonePill").textContent = `Zone ${json.zone || offer.zone_code || ""}`.trim();

      // Pay button -> create Stripe checkout session (real paywall)
      $("#payBtn").addEventListener("click", async () => {
        $("#payBtn").disabled = true;
        $("#payBtn").style.opacity = "0.8";
        $("#payNote").textContent = "Starting secure checkout…";

        const r2 = await fetch("/api/create-checkout-session", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ token })
        });

        const j2 = await r2.json().catch(() => ({}));
        if (!r2.ok || !j2.ok) {
          $("#payBtn").disabled = false;
          $("#payBtn").style.opacity = "1";
          $("#payNote").textContent = j2?.message || j2?.error || "Payment is not configured yet.";
          return;
        }

        // Redirect to Stripe Checkout
        location.href = j2.url;
      });
    }

    main();
  </script>
</body>
</html>
